---
title: The temporality of on-street parking - exploring the role of land use change on parking dynamics 
author: "Anthony Kimpton, Dominic Stead, Dorina Pojani, Jonathan Corcoran"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: word_document
---

Target journal: [*Environment and Planning B: Urban Analytics and City Science*](https://journals.sagepub.com/home/epb) (CiteScore = 4.5 & Impact Factor 2.8) is a good potential fit with the author's guide [here](https://journals.sagepub.com/author-instructions/EPB) and examples [here](https://journals.sagepub.com/doi/full/10.1177/2399808320954205) and [here](https://journals.sagepub.com/doi/full/10.1177/2399808320942779).

```{r setup, include=FALSE}
library(knitr)
options(scipen = 999, digits = 3)
opts_chunk$set(include = FALSE, cache = FALSE, results = TRUE, warning = FALSE, echo = FALSE, message = FALSE, dpi = 600, out.width="100%", eval = TRUE, fig.width = 7.48
)
knit_hooks$set(crop = hook_pdfcrop)
library(flextable)
library(mlogit)
library(nnet)
library(stargazer)
library(DT)
library(summarytools)
library(descr)
library(ggalluvial)
library(tmaptools)
library(rgdal)
library(ggplot2)
library(compositions)
library(GGally)
library(cowplot)
library(rgdal)
library(janitor)
library(kableExtra)
library(tidyverse)
library(sf)
library(tmap)
```

```{r read, cache=TRUE}
if (!file.exists("./../outputs/cluster_intensity.RData")) {
  print("Running the read and clean scripts")
  setwd("./../src/")
  source("./../src/1-load.R")
  source("./../src/2-clean.R")
  source("./../src/3-cluster.R")
  setwd("./../analysis/")
}

print("Reading the cleaned data into the environment.")

for (file in list.files(path = "./../outputs", pattern="*.shp")){
  print(file)
  assign(gsub(".shp", "",file),
         readOGR(dsn = paste("./../outputs/", file, sep = "")))
  }

for (file in list.files(path = "./../outputs", pattern="*.RData")){
  print(file)
  assign(gsub(".RData", "",file),
         readRDS(paste("./../outputs", file, sep = "/")))
  }

my_palette <- RColorBrewer::brewer.pal(6, "Dark2") 
my_palette <- c(my_palette, "grey50")
```

```{r code, cache=TRUE}
df1 <- buffer_clue %>% 
  full_join(clue_data, by = "block_id") %>%  
  drop_na(census_year) %>% 
  mutate_at(vars(starts_with(c("bar_", "cafe_", #weighting
                               "dwelling_", "m2_",
                               "parking_n_", "services_"))),
                 list(~ round(.* weighting,0))) %>% 
  group_by(street_marker, census_year) %>% 
  summarise_at(vars(starts_with(c("bar_", "cafe_", #collapsing by meter and year 
                               "dwelling_", "m2_",
                               "parking_n_", "services_"))),
               sum) %>% 
  ungroup() %>%
  mutate(total_m2 = rowSums(select(., starts_with("m2_")))) %>%
  mutate_at(vars(starts_with("m2_")), #creating proportional landuse
                 list(proportion = ~ ./total_m2)) %>%
  mutate_at(vars(ends_with("_proportion")), list(squared = ~ . * .)) %>% # ^2
  mutate(total_sum = rowSums(select(., ends_with("_squared"))),
         blau_land_use_entropy = 1 - total_sum,
         marker_year = paste(street_marker, census_year, sep = "_" )) %>%
  select(-total_sum, -total_m2, -starts_with("m2_")) %>% 
  left_join(cluster_marker, by = "marker_year") %>% 
  drop_na(street_marker) %>% 
  transmute(street_marker = street_marker,
            cluster_number = ifelse(is.na(cluster_number), NA, paste0("Type ", cluster_number)),
            cluster_number = factor(cluster_number),
            census_year = census_year,
            factor_year = factor(census_year),
            marker_year = marker_year,
            blau_land_use_entropy = blau_land_use_entropy,
            dining_bar_capacity = bar_pub_patron_limit + cafe_restaurant_seats_indoor + cafe_restaurant_seats_outdoor,
            retailers_n = services_retail_trade,
            dwellings_n = dwelling_house_townhouse + dwelling_residential_apartments + dwelling_student_apartments,
            commercial_parking = parking_n_commercial,
            private_parking = parking_n_private,
            residential_parking = parking_n_residential,
            services_n = services_administrative_and_support + services_agriculture_forestry_and_fishing +
              services_arts_and_recreation + services_construction + services_education_and_training +
              services_electricity_gas_water_and_waste + services_financial_and_insurance +
              services_health_care_and_social_assistance + services_information_media_and_telecommunications +
              services_manufacturing + services_mining + services_other +
              services_professional_scientific_and_technical + services_public_administration_and_safety +
              services_rental_hiring_and_real_estate + services_transport_postal_and_warehousing +
              services_wholesale_trade)

df2 <- df1 %>%
  select(street_marker, census_year, cluster_number) %>%
  pivot_wider(id_cols = street_marker,
              names_from = census_year,
              names_prefix = "y",
              values_from = cluster_number)
  
df2$na_counted = apply(is.na(df2), 1, sum)

df2 <- df2 %>%
  transmute(street_marker = street_marker,
            years_collected = 9 - na_counted)

ggplot(data = df2, mapping = aes(x = years_collected)) + 
  geom_histogram(aes(y = stat(width*density))) +
  scale_y_continuous(labels = scales::label_percent())

df3 <- df1 %>%
  left_join(df2, by = "street_marker")

val1 <- df3 %>%
  transmute(years_collected,
            total = 9) %>% 
  summarise(sum = sum(years_collected),
            total = sum(total)) %>%
  transmute(nonmissing = sum/total*100)

whole <- df3 %>%
  filter(years_collected > 6)

foreign::write.dta(whole, "../whole.dta")

res <- cor(select(whole, -street_marker, -cluster_number, -census_year, -factor_year, -marker_year))
round(res, 2)
```

# Abstract

# Keywords
* on-street parking
* land use
* mixed use
* temporality
* cluster analysis

# 1.	Introduction

# 2.	Literature review

## 2.1. The Aims of On-street Parking

## 2.2. The Turnover of On-street Parking

## 2.3. The Role of Nearby Land Use

Dominic's [Dovey & Pafka 2017](https://www.tandfonline.com/doi/pdf/10.1080/14649357.2017.1281996), [Gehrke & Clifton 2016](https://conservancy.umn.edu/bitstream/handle/11299/181564/JTLU_vol9no1_pp171-186.pdf?sequence=1&isAllowed=y), [Manaugh & Kreider 2013](https://jtlu.org/index.php/jtlu/article/download/291/305), and [Song et al. 2013](https://reader.elsevier.com/reader/sd/pii/S0198971513000689?token=2FC8C0FAADF86B5855714E537A8AB1CDF9967135BB97A2C2D7C34E50CDAC8CF3016CF021E172BDEB105F7367D857B0D0) about land use entropy and interaction conceptualizations and operationalizations.

# 3.	Classifying and modelling the temporality of on-street parking arrivals

## 3.1.	On-street parking sensor data from 2011 to 2019

There are `r length(unique(parking_sensors$strt_mr))` parking sensors collecting `r format(sum(parking_turnover$count), big.mark = ",")` arrivals and departures across 2011 to 2019.

```{r fig1, fig.cap="**Fig 1. 349,423,785 on-street parking bay arrivals across 2011 to 2019**", include=TRUE, fig.asp=0.5}
df1 <- parking_turnover %>% 
  group_by(year, whour) %>% 
  summarise(count = sum(count)) %>% 
  mutate(year = factor(as.character(year)),
         count = count/100000)

ggplot(data = df1, mapping = aes(x = whour, y = count)) + 
  geom_line(mapping = aes(whour)) +
  facet_wrap(~year) +
  scale_x_continuous(breaks = seq(11, 168, 24), 
                     limits=c(0, 168),
                     labels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")) +
  theme_classic() +
  theme(panel.border = element_blank(),
        strip.background =element_rect(fill="white"),
        strip.text = element_text(colour = 'black', face="bold", hjust = 0.5),
        axis.text.x = element_text(angle = 30),
        panel.grid.minor.x = element_line(colour = "grey80"),
        panel.grid.major.x = element_line(colour = "grey95"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_line(colour = "grey95")) +
  ylab("Parking Bay Arrivals [100k]") +
  xlab("Day [noon]")
```

## 3.2. Census of Land Use and Employment (CLUE) from 2011 to 2019

There are `r length(clue_data)-2` counts of land use and services collected from 2011 to 2019 (see Appendix A, Table 1), which have been aggregated to `r length(unique(clue_blocks$block_id))` CLUE blocks.

Land use diversity is operationalized using 

$$Blau = 1 - \sum_{i=1}^k p_i^2$$

where $k$ is the number of land use types and $p_i$ is the proportional area of each land use type.

## 3.3. Fixed-effects multinomial logit model

The fixed-effects, multinomial logit model initially proposed by Chamberlain ( [1980](https://doi.org/10.2307/2297110)) is used to explain parking meter type, and its formula is:

$$\forall j\in (1,...,J): y^*_i_t_j = \alpha_i_j + x_i_t\beta_j + \epsilon_i_t_j$$

where $i$ is individual parking meters, $t$ is each observation collected from 2011 to 2019, and $j = 1,...,J$ is parking meter type as an ordinal dependent variable with the most frequent outcome (i.e. Type 3) set as the baseline. Further, $y^*_i_t_j$ is the latent propensity for parking meter $i$ to be $j$ at $t$, $\alpha_i_j$ is the fixed intercept, $x_i_t$ is a matrix of land use independent variables that are weighted according intersection within a 250m buffer surounding the parking meter, $\beta_j$ is the coeficent vector, and $\epsilon_i_t_j$ is the Gumbel-type error term distributed across a $j$ outcomes ( [Pforr 2017](https://doi.org/10.21241/ssoar.52315)).

# 4.	Results

## 4.1. Classifying parking bays by parking arrivals and year

```{r fig2, include=TRUE, fig.cap="**Fig 2. Angular means for parking bay types**", fig.asp=0.75}
ggplot(cluster_count, aes(x = whour, y = prob, col = cluster_number)) +
  geom_line(stat='identity') +
  facet_wrap(~cluster_number) +
  coord_polar() +
  scale_x_continuous(breaks = (0:6) * 24 ,
                     labels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")) +
        theme_bw() +
      theme(axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            panel.border = element_blank(),
            legend.position = "none",
            strip.background = element_blank(),
            strip.text = element_text(colour = 'black', face="bold")) +
  scale_colour_manual(values = my_palette, guide="none")
```

```{r fig3, include=TRUE, fig.cap="**Fig 3. Change between parking bay types**", cache=TRUE}
df1 <- whole %>%
  transmute(street_marker,
            cluster_number = as.character(cluster_number),
            year_lab = paste0("y", census_year)) %>% 
  pivot_wider(names_from = year_lab, values_from = cluster_number) %>%
  group_by(y2011, y2012, y2013, y2014, y2015, y2016, y2017, y2018, y2019) %>%
  summarise(freq = n()) %>% 
  ungroup() %>%
  mutate(similar = row_number()) %>%
  pivot_longer(cols = starts_with("y"), names_to = "year", values_to = "cluster_number") %>% 
  mutate(year = gsub("y", "", year),
         cluster_number = ifelse(is.na(cluster_number), "Unrecorded", cluster_number),
         cluster_number = ordered(cluster_number, levels = c("Type 1", "Type 2", "Type 3", "Type 4", "Type 5", "Type 6", "Unrecorded"))) 
  
ggplot(df1,
       aes(x = year, y = freq, alluvium = similar,
           stratum = cluster_number,
           fill = cluster_number,
           label = cluster_number)) +
  geom_flow(stat = "alluvium", lode.guidance = "frontback") +
  geom_stratum() +
  theme_bw() +
  theme(legend.position = "right") +
  scale_fill_manual(values = my_palette, name= "Parking Turnover") +
  ylab("Frequency") + xlab("Year")
```

```{r fig4, include=TRUE, fig.cap="**Fig 4. Parking bay type and CLUE blocks by year**"}
sf1 <- victoria %>% 
  st_as_sf()

df1 <- whole %>%
  transmute(street_marker,
            census_year,
            cluster_number = as.character(cluster_number),
            cluster_number = ifelse(is.na(cluster_number), "Unrecorded", cluster_number),
            cluster_number = ordered(cluster_number, levels = c("Type 1", "Type 2", "Type 3", "Type 4", "Type 5", "Type 6", "Unrecorded"))) 

sf2 <- onstreet_bays %>%
  st_as_sf() %>%
  st_centroid() %>%
  transmute(street_marker = strt_mr) %>% 
  drop_na() %>%
  right_join(df1, by = "street_marker")

sf3 <- st_bbox(sf2) %>% 
  st_as_sfc()

tmap_mode("plot")

tm_shape(sf1, bbox = sf2) +
  tm_polygons(col = "grey80", border.col = "grey80") +
  tm_shape(clue_blocks) +
  tm_polygons(col = "white", border.col = "grey50", lwd = 1) +
  tm_shape(sf2) +
  tm_dots(col = "cluster_number", palette = my_palette, title = "Parking Turnover") +
  tm_facets(by = "census_year", ncol = 3) +
  tm_shape(inner_melbourne) +
  tm_borders(col = "black", lwd = 2) +
  tm_layout(panel.label.color = "white", panel.label.bg.color = "black",
            bg.color = "grey60")
```

## 4.2.	The role of nearby land use

Out of the `r length(unique(parking_sensors$strt_mr))` parking sensors, `r length(unique(whole$street_marker))` were recorded for at least 7 of the 9 years. In effect, dropping parking sensors where fewer than seven years was collected is dropping `r 100- sum(val1$nonmissing)`% of classified observations overall.   

```{r fixed_effects}
#https://rpubs.com/tnearey/rcrMultinomPB52
#https://www.cmm.bris.ac.uk/lemma/pluginfile.php/15198/mod_resource/content/2/C10%20Single-level%20and%20Multilevel%20Models%20for%20Nominal%20Responses.pdf
grand_mean_centred <- function(x) {
    scale(x, scale = FALSE)
}

by_100 <- function(x) {
    x = x / 100
}

df1 <- whole %>%
  mutate_at(7:13, (grand_mean_centred)) %>%
  mutate_at(7:13, (by_100)) %>%
  mutate(row_id = row_number(),
         blau_land_use_entropy = blau_land_use_entropy * 100)

df2 <- mlogit.data(df1, choice = "cluster_number", shape = "wide", id.var = "street_marker")

for (i in 6:13){
  j <- i-5
  f0 <- paste0("cluster_number ~ 0 |", names(df1)[i], " | 0")
  assign(print(paste0("m", j)), mlogit(as.formula(f0), data= df2, reflevel = "Type 3", seed = 1234))
}
#covariate.labels = labs1
stargazer(m1, m2, m3, m4, m5, m6, m7, m8, type="html",
          title="Multinomial Fixed Effects Model", out="bivariate.htm",
          model.numbers = FALSE, digits = 2, apply.coef = exp, add.lines=
            list(c("AIC",
                   round(bbmle::AIC(m1), 0),
                   round(bbmle::AIC(m2), 0),
                   round(bbmle::AIC(m3), 0),
                   round(bbmle::AIC(m4), 0),
                   round(bbmle::AIC(m5), 0),
                   round(bbmle::AIC(m6), 0),
                   round(bbmle::AIC(m7), 0),
                   round(bbmle::AIC(m8), 0))))

f1 <- 'cluster_number ~ 0 | commercial_parking + dining_bar_capacity |0'

f2 <- 'cluster_number ~ 0 | commercial_parking + dining_bar_capacity +
dwellings_n |0'

f3 <- 'cluster_number ~ 0 | commercial_parking + dining_bar_capacity +
dwellings_n + retailers_n |0'

f4 <- 'cluster_number ~ 0 | commercial_parking + dining_bar_capacity +
dwellings_n + retailers_n + services_n |0'

f5 <- 'cluster_number ~ 0 | commercial_parking + dining_bar_capacity +
dwellings_n + retailers_n + services_n + private_parking |0'

f6 <- 'cluster_number ~ 0 | commercial_parking + dining_bar_capacity +
dwellings_n + retailers_n + services_n + private_parking +
blau_land_use_entropy |0'

m11 <- mlogit(as.formula(f1), data= df2, reflevel = "Type 3", seed = 1234)
m12 <- mlogit(as.formula(f2), data= df2, reflevel = "Type 3", seed = 1234)
m13 <- mlogit(as.formula(f3), data= df2, reflevel = "Type 3", seed = 1234)
m14 <- mlogit(as.formula(f4), data= df2, reflevel = "Type 3", seed = 1234)
m15 <- mlogit(as.formula(f5), data= df2, reflevel = "Type 3", seed = 1234)
m16 <- mlogit(as.formula(f6), data= df2, reflevel = "Type 3", seed = 1234)

#covariate.labels = labs1
stargazer(m11, m12, m13, m14, m15, m16, type="html",
          title="Multinomial Fixed Effects Model", out="refinement.htm",
          digits = 2, apply.coef = exp,
          add.lines= list(c("AIC",
                            round(bbmle::AIC(m11), 0),
                            round(bbmle::AIC(m12), 0),
                            round(bbmle::AIC(m13), 0),
                            round(bbmle::AIC(m14), 0),
                            round(bbmle::AIC(m15), 0),
                            round(bbmle::AIC(m16), 0))))

stargazer(m16, type="html",
          title="Multinomial Fixed Effects Model", out="final.htm",
          digits = 2, apply.coef = exp,
          add.lines= list(c("AIC",
                            round(bbmle::AIC(m16), 0))))

scoretest(m16, heterosc = TRUE)

relative_risk_ratios <- round(exp(coefficients(m16)), 2)

inv_relative_risk_ratios <- round(1/exp(coefficients(m16)), 2) 
```

```{r include=TRUE}
summary(m16)

relative_risk_ratios

inv_relative_risk_ratios
```

# 5.	Policy implications

# 6.	Concluding remarks

# Appendix A

```{r fig5, fig.cap="**Fig 5. Parking bay arrivals for two of 3542 sensors by year**", include=TRUE, fig.width = 5.11, fig.asp=1.3, out.width="75%", out.height="75%"}
df1 <- parking_turnover %>% 
  filter(street_marker =="1194E"| street_marker == "1265W") %>% 
  group_by(street_marker, year, whour) %>% 
  summarise(count = sum(count)) %>% 
  mutate(year = factor(as.character(year)))

ggplot(data = df1, mapping = aes(x = whour, y = count)) + 
  geom_line(mapping = aes(whour)) +
  facet_grid(year~street_marker) +
  scale_x_continuous(breaks = seq(11, 168, 24), 
                     limits=c(0, 168),
                     labels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")) +
  theme_classic() +
  theme(panel.border = element_blank(),
        strip.background =element_rect(fill="black"),
        strip.text = element_text(colour = 'white', face="bold", hjust = 0.5),
        axis.text.x = element_text(angle = 30),
        panel.grid.minor.x = element_line(colour = "grey80"),
        panel.grid.major.x = element_line(colour = "grey95"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_line(colour = "grey95")) +
  ylab("Annual On-Street Arrivals [n]") +
  xlab("Day [noon]")
```

```{r table1, include=TRUE}
clue_data %>%
  select(-block_id) %>%
  mutate(census_year = as.factor(census_year)) %>% 
  group_by(census_year) %>% 
  summarise_all(list(mean = mean)) %>%
  gather(explanatory_variable, value, -census_year) %>%
  spread(census_year, value) %>%
  as_tibble() %>%
  mutate_at(2:10, round, 1) %>% 
  mutate(explanatory_variable = gsub("_mean", "", explanatory_variable)) %>%
  flextable() %>% 
  set_header_labels(explanatory_variable = "CLUE count") %>% 
  theme_booktabs() %>% 
  set_caption(caption = "***Table 1. Mean counts for CLUE blocks by year***") %>% 
  fontsize(size = 8, part = "body")
```

```{r table1_interactive, include=FALSE}
clue_data %>%
  select(-block_id) %>%
  mutate(census_year = as.factor(census_year)) %>% 
  group_by(census_year) %>% 
  summarise_all(list(mean = mean, sd = sd)) %>%
  gather(explanatory_variable, value, -census_year) %>%
  spread(census_year, value) %>%
  as_tibble() %>%
  mutate_at(2:10, round, 1) %>% 
  mutate(explanatory_variable = gsub("_mean", "", explanatory_variable)) %>% 
  datatable(.,
            rownames = FALSE,
            extensions = 'Buttons',
            options = list(dom = 'Bfrtip',
                         buttons = c('copy', 'csv', 'excel', 'pdf', 'print')),
            caption = 'Table 1. Mean and Standard Deviation for all available CLUE data')
```

```{r fig6, include=TRUE, fig.cap="**Fig 6. The proportional area of Census of Land Use and Employment (CLUE) blocks located within 250m of a parking sensor**", fig.width = 3.54, fig.asp=1, out.width="50%", out.height="50%"}

parking_sensor <- "3876N"

sf1 <- sensor_buffer %>% 
  st_as_sf() %>% 
  filter(strt_mr == parking_sensor)

sf2 <- sf1 %>%
  st_buffer(0.0006)

df1 <- buffer_clue %>%
  filter(street_marker == parking_sensor) %>% 
  select(block_id, weighting)

sf3 <- clue_blocks %>%
  st_as_sf() %>%
  inner_join(df1, by = "block_id")

sf4 <- parking_sensors %>%
  st_as_sf() %>% 
  filter(strt_mr == parking_sensor)

tmap_mode("plot")

tm_shape(clue_blocks, bbox = sf2) +
  tm_polygons(col = "white", border.col = "navy", lwd = 1)  +
  tm_shape(sf3) +
  tm_polygons(col = "weighting", border.col = "navy", lwd = 1, palette = RColorBrewer::brewer.pal(9, "Blues")[3:9], style = "cont", title = "Weighting") +
  tm_shape(parking_sensors) +
  tm_symbols(col = "grey50", border.col = "grey50", size = 0.03, border.alpha = 0) +
  tm_shape(sf4) +
  tm_symbols(col = "red", border.col = "red", size = 0.03, border.alpha = 0) +
  tm_shape(sf1) +
  tm_borders(col = "red") +
  tm_layout(legend.position = c("right", "top"), legend.title.size = 0.8, legend.bg.color = "white", legend.bg.alpha = 0.5) +
  tm_scale_bar(width = 0.7, position = c("center", "bottom"), text.size = 0.6) +
  tm_compass(position = c("left", "top"))
```

250m weighted-buffer (of my own design) to operationalize [Dovey and Pafka 2017's](https://www.tandfonline.com/doi/pdf/10.1080/14649357.2017.1281996) "experiential mix"

```{r interactive_maps, include=TRUE, fig.asp=1.5, eval=FALSE}
tmap_mode("view")

sf1 <- victoria %>% 
  st_as_sf()

df1 <- cluster_marker %>%
  separate(col = marker_year, into = c("street_marker", "year"), sep = "\\_") %>%
  mutate(year = as.numeric(year), 
         cluster_number = paste0( 'Type ' , cluster_number))

sf2 <- onstreet_bays %>%
  st_as_sf() %>%
  st_centroid() %>% 
  mutate(street_marker = strt_mr) %>% 
  select(street_marker) %>% 
  drop_na() %>%
  right_join(df1, by = "street_marker")

sf3 <- st_bbox(sf1) %>% 
  st_as_sfc()

tm_shape(clue_blocks, bbox = sf2, name = "CLUE block") +
  tm_polygons(col = "white", border.col = "grey50", lwd = 1) +
  tm_shape(filter(sf2, year > 2012 & year < 2016), name = "Parking sensor") +
  tm_dots(col = "cluster_number", palette = my_palette, title = "Parking Turnover") +
  tm_facets(by = "year", ncol = 3) +
  tm_shape(inner_melbourne, name = "City of Melbourne") +
  tm_borders(col = "black", lwd = 2) +
  tm_layout(panel.label.color = "white", panel.label.bg.color = "black",
            bg.color = "grey60")
```